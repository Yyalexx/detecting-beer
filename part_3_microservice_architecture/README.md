 # Сервис (продакшен)  
 **Микросервисная архитектура** составлена из 3-х сервисов:  
 - **images**  
 - **model**
 - **dataframe**  

   -  Сервис **images** производит предварительную обработку данных. Он принимает на вход фотографии витрин, экспортированные из базы 1С в папку *input_images*, производит их обработку и помещает обработанные изображения во внутреннюю папку проекта *resized_images*. ID обработанных изображений помещаются в очередь *images*. Изображение, для которого произведена обработка, удаляется из папки *input_images*.  

   -  Сервис **model**  принимает из очереди *images* ID изображений, считывает по ним изображения из папки *resized_images*. Сервис формирует вектор предсказания, который помещается в очередь *predict*, идентификатором сообщения служит ID изображения. Изображение, для которого сформирован вектор предсказания, удаляется из папки *resized_images*.  
    -    Сервис **dataframe** принимает из очереди *predict* ID изображения и соответствующий ему вектор предсказания. Из полученных векторов предсказания составляется датафрейм, который записывается в файл predict_df.csv.  
Все сервисы работают в непрерывном режиме, постоянно анализируя наличие фотографий в папке *input_images* и обновляя файл predict_df.csv.  
# Сервис **images**
Сервис **images** выполняет 2 функции.  
**Первая функция** сервиса состоит в приведении размера входных изображений к единому значению 640х640. Реализована библиотекой PIL с использованием фильтра Ланцоша. 
При сохранении изображения с помощью библиотеки PIL все метаданные exif стираются, поэтому сохраненное изображение без метаинформации уже не сохраняет информацию об ориентации, то есть непредсказуемо поворачивается. Поскольку PIL стирает метаинформацию при сохранении изображения, то при наличии тега ориентации обработанное изображение необходимо поворачивать. Это **вторая функция** сервиса **images**.
# Сервис **model**  
Для формирования вектора предсказания используются предобученные модели. Обучение модели описано в разделе [Тренировка модели](https://github.com/Yyalexx/detecting-beer/tree/master/part_2_model_training).  
На данный момент обучена одна модель для распознавания одного класса class_0. В коде сервиса предусмотрено использование 2-х моделей, *model_cl_0.pt* - для класса 0, *model_cl_1_4.pt* - для классов 1-4. Вместо второй модели пока стоит модель-заглушка для отработки объединения предсказаний двух моделей в вектор предсказания. Для обучения второй модели сейчас производится разметка данных.  
Применение микросервисной структуры позволяет оперативно добавлять новые анализируемые товарные позиции по ходу процесса разметки данных и обучения соответствующих моделей.  
# Сервис **dataframe**  
Сервис формирует датафрейм из векторов предсказаний и экспортирует его в файл. Планируется создание базы данных PostgreSQL, экспорт датафрейма в базу данных предварительно отработан. Заказчику интересен экспорт данных в исходную базу 1С, откуда выгружаются фотографии, но этот вопрос находится за пределами данного проекта.  
## Файловая структура

**vms_dk**

 - **images**  
      - **src**  
          - *images.py* 
    - *Dockerfile*
    - *requirements.txt* 
 - **model**  
      - **src**  
          - **yolov5**  
            - *файлы для torch.hub*
          - *model_cl_0.pt* 
          - *model_cl_1_4.pt*
          - *model.py*
    - *Dockerfile*
    - *requirements.txt*      
 - **dataframe**  
      - **src**   
          - *dataframe.py*
    - *Dockerfile*
    - *requirements.txt* 
- **vvol**  
  - **input_images**
  - **resized_images**
  - *predict_df.csv*  
- *docker-compose.yml*    
  &ensp;  

Контейнеры с сервисами загружены на [DOCKER HUB](https://hub.docker.com/)  
- [контейнер с сервисом **images**](https://hub.docker.com/r/yyalexx/vms_dk_images/)  
- [контейнер с сервисом **model**](https://hub.docker.com/r/yyalexx/vms_dk_model)  
- [контейнер с сервисом **dataframe**](https://hub.docker.com/r/yyalexx/vms_dk_dataframe)  
При сборке из готовых контейнеров надо поменять строки в файле *docker-compose.yml*:  


***СТРОКИ:***
```
images:  
  build:  
    context: ./images 
```

***поменять на:***
```  
images:  
  image: vms_dk_images:latest  
  container_name: images 
```
***СТРОКИ:***
```
model:  
  build:  
    context: ./model 
```

***поменять на:***
```  
images:  
  image: vms_dk_model:latest  
  container_name: model 
```

***СТРОКИ:***
```
model:  
  build:  
    context: ./dataframe 
```

***поменять на:***
```  
images:  
  image: vms_dk_dataframe:latest  
  container_name: dataframe 
```